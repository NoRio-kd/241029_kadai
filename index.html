<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Firebase:v9:Chatã‚¢ãƒ—ãƒª</title>
<link rel="stylesheet" href="./css/style.css">
</head>
<body>

<!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
<div id="chat-container">
    <div id="output" style="height:300px;overflow: scroll;">
        <!-- ã“ã“ã«Jsã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
    </div>   
    <div>
        <input type="text" id="uname" placeholder="Your name">
    </div>
    <div>
        <textarea id="text" placeholder="message-input" cols="30" rows="1" style="overflow: auto;"></textarea>
        <button id="send">é€ä¿¡</button>
    </div>
</div>

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Firebaseã¨DeepL APIã‚’ä½¿ç”¨ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, update, onChildChanged, onChildRemoved } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBzvBwZ9zDGiR3lICoTzq3lupKOTOiTe6U",
      authDomain: "gsdemo-2a1b3.firebaseapp.com",
      projectId: "gsdemo-2a1b3",
      storageBucket: "gsdemo-2a1b3.appspot.com",
      messagingSenderId: "868147135106",
      appId: "1:868147135106:web:3740001e4abd14bbbc6a9b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, "chat");

    let currentUser = ""; 

    // DeepL APIã‚­ãƒ¼ã‚’è¨­å®š
    const deeplApiKey = '9a27535e-79e9-4cde-91c2-1f0758bfffe4:fx'; // è‡ªåˆ†ã®DeepL APIã‚­ãƒ¼

    // DeepL APIã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è‹±èªã«ç¿»è¨³ã™ã‚‹é–¢æ•°
    async function translateToEnglish(text) {
        try {
            const response = await fetch("https://api-free.deepl.com/v2/translate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    auth_key: deeplApiKey,
                    text: text,
                    target_lang: "EN" // ç¿»è¨³å…ˆã‚’è‹±èªã«è¨­å®š
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.translations[0].text; // ç¿»è¨³ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
        } catch (error) {
            console.error("Translation Error:", error);
            return "Translation Error";
        }
    }

    // é€ä¿¡å‡¦ç†
    $("#send").on("click", async function() {
        currentUser = $("#uname").val();
        const text = $("#text").val();

        // ç¿»è¨³å‡¦ç†ã‚’å®Ÿè¡Œ
        const translatedText = await translateToEnglish(text);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã«ç¿»è¨³ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
        const msg = {
            uname: currentUser,
            timestamp: new Date().toISOString(),
            text: text,
            translatedText: translatedText // ç¿»è¨³çµæœã‚’è¿½åŠ 
        };

        const id = push(dbRef);
        set(id, msg);
        $("#text").val('');
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå‡¦ç†
    onChildAdded(dbRef, function(data) {
        const msg = data.val();
        const key = data.key;
        const timestamp = new Date(msg.timestamp);

        const formattedTime = timestamp.toLocaleString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            day: '2-digit'
        });

    // è‰²å¤‰ãˆã‚‹
    let messageClass = (msg.uname === "Noriki") ? "sent" : "received";


        // HTMLè¦ç´ ã®ç”Ÿæˆ
        let h = `
            <p class="message ${messageClass}" id="${key}">
                <strong>${msg.uname}</strong><br>
                <span contentEditable="true" id="${key}_update">${msg.text}</span><br>
                <span class="time">Sent on ${formattedTime}</span><br>
                <strong>Translated:</strong>
                <span>${msg.translatedText}</span><br> <!-- ç¿»è¨³çµæœã®è¡¨ç¤º -->
                <span class="remove" data-key="${key}">ğŸ—‘ï¸</span>
                <span class="update" data-key="${key}">ğŸ†™</span>
            </p>
        `;
        $("#output").append(h); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
    });

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#output').on("click", ".remove", function() {
        const key = $(this).attr("data-key");
        remove(ref(db, "chat/" + key));
    });

    // æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#output').on("click", ".update", function() {
        const key = $(this).attr("data-key");
        update(ref(db, "chat/" + key), {
            text: $("#" + key + "_update").html()
        });
    });

    // Firebaseå´ã§å‰Šé™¤ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    onChildRemoved(dbRef, (data) => {
        $("#" + data.key).remove();
    });

    // Firebaseå´ã§æ›´æ–°ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    onChildChanged(dbRef, (data) => {
        $("#" + data.key + "_update").html(data.val().text).fadeOut(800).fadeIn(800);
    });
</script>
</body>
</html>
